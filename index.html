<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحديث قاعدة البيانات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f9fc;
            direction: rtl;
        }
        header {
            background-color: #007bff;
            color: white;
            text-align: center;
            padding: 10px 0;
            font-size: 1.5em;
            font-weight: bold;
        }
        h1 {
            color: #333;
            text-align: center;
            font-size: 1.8em;
            margin: 20px 0;
        }
        form {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        td {
            padding: 10px;
            vertical-align: middle;
        }
        label {
            font-size: 0.9em;
            color: #555;
        }
        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }
        input:focus, select:focus {
            border-color: #007bff;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border-radius: 5px;
            font-size: 1em;
        }
        button:hover {
            background-color: #0056b3;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px;
            background-color: #f44336;
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            font-size: 0.9em;
        }
        .popup.success {
            background-color: #4caf50;
        }
        .popup.error {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <header>معمل نور المدينة</header>
    <h1>تحديث قاعدة البيانات</h1>
    <form id="update-form">
        <table>
            <tr>
                <td><label for="item">المادة:</label></td>
                <td>
                    <select id="item" required onchange="showAdditionalFields()">
                        <option value="" disabled selected>اختر المادة</option>
                        <option value="زد باب">زد باب</option>
                        <option value="زد شباك">زد شباك</option>
                        <option value="جنب">جنب</option>
                        <option value="تي">تي</option>
                        <option value="نقشة">نقشة</option>
                        <option value="بنل">بنل</option>
                        <option value="حديد جنب">حديد جنب</option>
                        <option value="حديد منتشة">حديد منتشة</option>
                        <option value="قلابة">قلابة</option>
                        <option value="ماسكة تك">ماسكة تك</option>
                        <option value="ماسكة دبل">ماسكة دبل</option>
                    </select>
                </td>
            </tr>
            <tr id="additional-nqsha" style="display:none;">
                <td><label for="nqsha">خيارات نقشة:</label></td>
                <td>
                    <select id="nqsha">
                        <option value="ركم">ركم</option>
                        <option value="ربع جام">ربع جام</option>
                    </select>
                </td>
            </tr>
            <tr id="additional-bnl" style="display:none;">
                <td><label for="bnl">خيارات بنل:</label></td>
                <td>
                    <select id="bnl">
                        <option value="صغير">صغير</option>
                        <option value="كبير">كبير</option>
                    </select>
                </td>
            </tr>
            <tr id="additional-qalaba" style="display:none;">
                <td><label for="qalaba">خيارات قلابة:</label></td>
                <td>
                    <select id="qalaba">
                        <option value="باب">باب</option>
                        <option value="شباك">شباك</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="type">النوع:</label></td>
                <td>
                    <select id="type" required>
                        <option value="" disabled selected>اختر النوع</option>
                        <option value="سوبر">سوبر</option>
                        <option value="نورمال">نورمال</option>
                        <option value="حديد">حديد</option>
                        <option value="إكسسوارات">إكسسوارات</option>
                    </select>
                </td>
            </tr>
            <tr id="color-row">
                <td><label for="color">اللون:</label></td>
                <td>
                    <select id="color" required>
                        <option value="" disabled selected>اختر اللون</option>
                        <option value="أبيض">أبيض</option>
                        <option value="صاج">صاج</option>
                        <option value="رصاصي">رصاصي</option>
                        <option value="بلوطي">بلوطي</option>
                        <option value="أسود">أسود</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="quantity">الكمية:</label></td>
                <td><input type="number" id="quantity" placeholder="أدخل الكمية" required></td>
            </tr>
            <tr>
                <td><label for="price">سعر المفرد:</label></td>
                <td><input type="number" id="price" placeholder="أدخل سعر المفرد (اختياري)"></td>
            </tr>
            <tr>
                <td><label for="date">التاريخ:</label></td>
                <td><input type="date" id="date" required></td>
            </tr>
        </table>
        <button type="submit">تحديث البيانات</button>
    </form>

    <div id="popup" class="popup"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const form = document.getElementById('update-form');
        const popup = document.getElementById('popup');

        function showAdditionalFields() {
            const item = document.getElementById('item').value;

            if (item === "حديد جنب" || item === "حديد منتشة") {
                document.getElementById('color-row').style.display = 'none';
            } else {
                document.getElementById('color-row').style.display = 'table-row';
            }

            document.getElementById('additional-nqsha').style.display = (item === 'نقشة') ? 'table-row' : 'none';
            document.getElementById('additional-bnl').style.display = (item === 'بنل') ? 'table-row' : 'none';
            document.getElementById('additional-qalaba').style.display = (item === 'قلابة') ? 'table-row' : 'none';
        }

        function showPopup(message, type) {
            popup.textContent = message;
            popup.className = `popup ${type}`;
            popup.style.display = 'block';
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const item = document.getElementById('item').value;
            const type = document.getElementById('type').value;
            const color = document.getElementById('color') ? document.getElementById('color').value : null;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const price = document.getElementById('price').value ? parseFloat(document.getElementById('price').value) : null;
            const date = document.getElementById('date').value;

            const nqsha = document.getElementById('nqsha') ? document.getElementById('nqsha').value : null;
            const bnl = document.getElementById('bnl') ? document.getElementById('bnl').value : null;
            const qalaba = document.getElementById('qalaba') ? document.getElementById('qalaba').value : null;

            const newRow = {
                المادة: item,
                النوع: type,
                اللون: color || "غير محدد",
                الكمية: quantity,
                "سعر المفرد": price || "غير محدد",
                التاريخ: date,
                "خيارات نقشة": nqsha,
                "خيارات بنل": bnl,
                "خيارات قلابة": qalaba
            };

            const owner = "raslanbasha";
            const repo = "raslan";
            const filePath = "data.xlsx";
            const token = "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";

            try {
                showPopup("جاري جلب قاعدة البيانات...", "success");

                const fileResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                    headers: {
                        Authorization: `token ${token}`
                    }
                });

                if (!fileResponse.ok) {
                    throw new Error("فشل في جلب قاعدة البيانات.");
                }

                const fileData = await fileResponse.json();
                const content = atob(fileData.content);

                const workbook = XLSX.read(content, { type: "binary" });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                jsonData.push(newRow);

                const newWorksheet = XLSX.utils.json_to_sheet(jsonData);
                workbook.Sheets[sheetName] = newWorksheet;

                const newContent = XLSX.write(workbook, { type: "binary" });
                const newBase64Content = btoa(
                    Array.from(new Uint8Array(newContent)).map(byte => String.fromCharCode(byte)).join("")
                );

                showPopup("جاري تحديث قاعدة البيانات...", "success");

                const updateResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                    method: "PUT",
                    headers: {
                        Authorization: `token ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: "تحديث قاعدة البيانات",
                        content: newBase64Content,
                        sha: fileData.sha
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error("فشل في تحديث قاعدة البيانات.");
                }

                showPopup("تم تحديث قاعدة البيانات بنجاح!", "success");
                form.reset();
            } catch (error) {
                showPopup(`خطأ: ${error.message}`, "error");
            }
        });
    </script>
</body>
</html>